# Data 

#Pachages
```{r}
library(tidyverse)
library(metafor)
library(ggthemes)
library(cowplot)
library(scales)
library(knitr)
library(broom)
library(dplyr)
library(readxl)
library(gsheet)
library(janitor)
library(magrittr)
library(gsheet)
library(janitor) 
library(readr)
```


#Import data
```{r}
#wb_raw <- read_excel("data/ensaios_cooperativos_BRUSONE.xlsx") %>% 
wb_raw = gsheet2tbl("https://docs.google.com/spreadsheets/d/1vvAbRlidw2XklqoLd-3k8NqYWLTE4Okq0ZWghv_jFXs/edit?usp=sharing") %>% 
  group_by(study, brand_name) %>% 
  mutate(index = (inc*sev)/100) %>%
  mutate(n = n())      #columm with the number of rep
wb_raw
```


#Getting mean and study variance

```{r, warning=FALSE}
#Select colums to analyse, getting number of repetitions and mean values of sev, inc and yield
wb1 <- wb_raw %>% 
  group_by(study, year, location, state, cultivar, data_sowing, brand_name, group, active_ingredient, n) %>% 
  summarise(mean_sev = mean(sev),
            mean_inc = mean(inc),
            mean_yld = mean(yld),
            mean_index = mean(index))

#Getting the study variance of wheat blast index Obs. it needs to use the raw data
wb2_index <- wb_raw %>%
  filter(index != "NA") %>% 
  group_by(study, year) %>%  
  dplyr::select(active_ingredient, block, index) %>%
  group_by(study, year) %>% 
  do(tidy(aov(.$index ~ .$active_ingredient + factor(.$block)))) %>% 
  filter(term == "Residuals") %>% 
  dplyr::select(1,2,6)
names(wb2_index)[1] <- "study"
names(wb2_index)[2] <- "year"
names(wb2_index)[3] <- "v_index"

#Getting the study variance of wheat blast severity. Obs. it needs to use the raw data
wb2_sev <- wb_raw %>%
  filter(sev != "NA") %>% 
  group_by(study, year) %>%  
  dplyr::select(active_ingredient, block, sev) %>%
  group_by(study, year) %>% 
  do(tidy(aov(.$sev ~ .$active_ingredient + factor(.$block)))) %>% 
  filter(term == "Residuals") %>% 
  dplyr::select(1,2,6)
names(wb2_sev)[1] <- "study"
names(wb2_sev)[2] <- "year"
names(wb2_sev)[3] <- "v_sev"
 
#Getting the study variance of wheat blast incidence. Obs. it needs to use the raw data
wb2_inc <- wb_raw %>% 
  filter(inc != "NA") %>%
  group_by(study, year) %>%  
  dplyr::select(active_ingredient, block, inc) %>%
  group_by(study, year) %>% 
  do(tidy(aov(.$inc ~ .$active_ingredient + factor(.$block)))) %>% 
  filter(term == "Residuals") %>% 
  dplyr::select(1,2,6)
names(wb2_inc)[1] <- "study"
names(wb2_inc)[2] <- "year"
names(wb2_inc)[3] <- "v_inc"

#Getting the study variance of wheat yield. Obs. it needs to use the raw data
wb2_yld <- wb_raw %>% 
  filter(yld != "NA") %>%
  group_by(study, year) %>%  
  dplyr::select(active_ingredient, block, yld) %>%
  group_by(study, year) %>% 
  do(tidy(aov(.$yld ~ .$active_ingredient + factor(.$block)))) %>% 
  filter(term == "Residuals") %>% 
  dplyr::select(1,2,6)
names(wb2_yld)[1] <- "study"
names(wb2_yld)[2] <- "year"
names(wb2_yld)[3] <- "v_yld"

#Putting together the variances of sev, inc, and yld in the same data.frame
qmr = left_join(wb2_sev, wb2_inc, by = "study")
qmr1 = left_join(qmr, wb2_yld, by = "study")
qmr2 = left_join(qmr1, wb2_index, by = "study")

#Putting together the means values and variances of each dependent variable (sev, inc, yld)
wb_trial = full_join(wb1, qmr2, by = "study") %>% 
  dplyr::select(-year.x, -year.x.x, -year.y, -year.y.y)
names(wb_trial)[2] <- "year"
wb_trial
```

#Check columns for yld, sev, inc, index

```{r}
# Getting the check values of each variables (means and variances)
wb_check = wb_trial %>% 
  ungroup() %>% 
  filter(brand_name == "check")  %>% 
  mutate(check = brand_name, sev_check = mean_sev, v_sev_check = v_sev, inc_check = mean_inc, v_inc_check = v_inc, yld_check = mean_yld, v_yld_check = v_yld, index_check = mean_index, v_index_check = v_index) %>% 
  dplyr::select(study, yld_check, v_yld_check, sev_check, v_sev_check, inc_check, v_inc_check, index_check, v_index_check)

#Putting the check values to original data.frame
wb_data = wb_trial %>% 
  full_join(wb_check)
wb_data
```


#Exploring the data

```{r}
#By year
wb_data %>%
  tabyl(year)
```

```{r}
#By location
wb_data %>%
  tabyl(location, state)
 
```

```{r}
#By state
wb_data %>%
  tabyl(state)
```

```{r}
#By cultivar
wb_data %>%
  tabyl(cultivar)
```

```{r}
#By commercial product
wb_data %>%
  tabyl(brand_name)
```

```{r}
#By active ingredient
fung = wb_data %>% 
  tabyl(active_ingredient) %>% 
  filter(n>5) 
fung
```


#Fungicides to analyse

```{r, warning=FALSE}
#Select just the fungides used in more than 5 study
wheat_blast_data <- wb_data %>% 
  filter(active_ingredient %in% c("check", "(pyraclostrobin+epoxiconazole)+mancozebe", "(trifloxystrobin+protioconazole)+mancozebe", "azoxystrobin+tebuconazole", "mancozebe","thiophanate-methyl+mancozebe", "pyraclostrobin+epoxiconazole", "tebuconazole", "trifloxystrobin+protioconazole", "trifloxystrobin+tebuconazole", "azoxistrobina+mancozebe+tebuconazol"))

#Observe fungicides by year
wheat_blast_data %>%
  tabyl(active_ingredient, year)


# Renaming fungicides for whort names 
library(plyr)
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("check" = "AACHECK"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("(pyraclostrobin+epoxiconazole)+mancozebe" = "PYRA+EPOX+MANC"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("azoxistrobina+mancozebe+tebuconazol" = "AZOX+TEBU+MANC"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("(trifloxystrobin+protioconazole)+mancozebe" = "TFLX+PROT+MANC"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("azoxystrobin+tebuconazole" = "AZOX+TEBU"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("mancozebe" = "MANC"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("pyraclostrobin+epoxiconazole" = "PYRA+EPOX"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("tebuconazole" = "TEBU"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("thiophanate-methyl+mancozebe" = "TMET+MANC"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("trifloxystrobin+protioconazole" = "TFLX+PROT"))
wheat_blast_data$active_ingredient <- revalue(wheat_blast_data$active_ingredient, c("trifloxystrobin+tebuconazole" = "TFLX+TEBU"))
detach("package:plyr", unload = TRUE)

wheat_blast_data


wheat_blast_data <- wheat_blast_data %>% 
mutate(region = case_when(
    state == "DF" ~ "North",
    state == "MG" ~ "North",
    state == "MS" ~ "North",
    state == "MT" ~ "North",
    state == "SP" ~ "North",
    state == "PR" ~ "South")) 

```

#Sampling variances

##Index

```{r}
#Select just severity colums
index <- wheat_blast_data %>% 
  filter(mean_index != "NA") %>% 
  filter(mean_index>0) 
hist(index$mean_index)


# create the log of the sev variable
index = index %>%
  mutate(log_index = log(mean_index))
hist(index$log_index)


# create the sampling variance for the log of sev
index$vi_index = with(index, v_index / (n * mean_index^2))
hist(index$vi_index)

# # create the sampling variance for the log-ratio L, Hedges ey al. 1999 
# severity$log_v_sev = with(severity, v_sev *((1/(n * mean_sev^2))+ (1/(n * sev_check^2)))) # Paul et al. 2007
# hist(severity$log_v_sev)

#Select the variable to be writen on the severity data.frame for the analysis
index = index %>% 
  #select(1:10, 19,20,22:24) %>% 
  group_by(study, year, location, state, cultivar, data_sowing, brand_name, group, active_ingredient,n, index_check, yld_check, region) %>%
  summarise(mean_index = mean(mean_index),
            mean_yld = mean(mean_yld),
            log_index = mean(log_index),
            vi_index = mean(vi_index))

#Check the number of studysr
length(unique(index$study))


#Write a csv file to be analysed
write_csv(index,"data/dat_index.csv")

```



##Severity
```{r}
#Select just severity colums
severity <- wheat_blast_data %>% 
  filter(mean_sev != "NA") %>% 
  filter(mean_sev>0) 
hist(severity$mean_sev)


# create the log of the sev variable
severity = severity %>%
  mutate(log_sev = log(mean_sev))
hist(severity$log_sev)


# create the sampling variance for the log of sev
severity$vi_sev = with(severity, v_sev / (n * mean_sev^2))
hist(severity$vi_sev)

# # create the sampling variance for the log-ratio L, Hedges ey al. 1999 
# severity$log_v_sev = with(severity, v_sev *((1/(n * mean_sev^2))+ (1/(n * sev_check^2)))) # Paul et al. 2007
# hist(severity$log_v_sev)

#Select the variable to be writen on the severity data.frame for the analysis
severity = severity %>% 
  #select(1:10, 19,20,22:24) %>% 
  group_by(study, year, location, state, cultivar, data_sowing, brand_name, group, active_ingredient,n, sev_check, yld_check, region) %>%
  summarise(mean_sev = mean(mean_sev),
            mean_yld = mean(mean_yld),
            log_sev = mean(log_sev),
            vi_sev = mean(vi_sev))
            #log_v_sev = mean(log_v_sev))

#Check the number of studysr
length(unique(severity$study))


#Write a csv file to be analysed
write_csv(severity,"data/dat_sev.csv")

```

##Incidence
```{r}
incidence <- wheat_blast_data %>% 
  filter(mean_inc != "NA") %>% 
  filter(mean_inc>0) 
hist(incidence$mean_inc)


# create the log of the inc variable
incidence = incidence %>%
  mutate(log_inc = log(mean_inc))
hist(incidence$log_inc)


# create the sampling variance for the log of inc
incidence$vi_inc = with(incidence, v_inc / (n * mean_inc^2))
hist(incidence$vi_inc)

# # create the sampling variance for the log-ratio L, Hedges ey al. 1999 
# incidence$log_v_inc = with(incidence, v_inc *((1/(n * mean_inc^2))+ (1/(n * inc_check^2)))) # Paul et al. 2007
# hist(incidence$log_v_inc)

#Select the variable to be writen on the incidence data.frame for the analysis
incidence = incidence %>% 
  #select(1:10, 19,20,22:24) %>% 
  group_by(study, year, location, state, cultivar, data_sowing, brand_name, group, active_ingredient,n, inc_check, yld_check, region) %>%
  summarise(mean_inc = mean(mean_inc),
            mean_yld = mean(mean_yld),
            log_inc = mean(log_inc),
            vi_inc = mean(vi_inc))
            #log_v_sev = mean(log_v_sev))

#Check the number of studys
length(unique(incidence$study))


#Write a csv file to be analysed
write_csv(incidence,"data/dat_inc.csv")

```

##Yield
```{r}
yield <- wheat_blast_data %>% 
  filter(mean_yld != "NA")
hist(yield$mean_yld)

# Sampling variance for yield
yield$vi_yld <- with(yield, v_yld / n) # multivariate approach
hist(yield$vi_yld)

#Select the variable to be writen on the yield data.frame for the analysis
yield = yield %>% 
  group_by(study, year, location, state, cultivar, data_sowing, brand_name, group, active_ingredient,n, sev_check, inc_check, index_check, yld_check, region) %>%
  summarise(mean_sev = mean(mean_sev),
            mean_inc = mean(mean_inc),
            mean_yld = mean(mean_yld),
            vi_yld = mean(vi_yld))

#Check the number of studys
length(unique(yield$study))

#Write a data.frame
write_csv(yield, "data/dat_yld.csv")


```



